name: Deploy blog on Cloudflare Pages

on:
  push:
    paths:
      - "assets/**"
      - "_sass/**"
      - "_scripts/**"
      - "**.bib"
      - "**.html"
      - "**.js"
      - "**.liquid"
      - "**/*.md"
      - "**/*.Rmd"
      - "**/*.R"
      - "**.yml"
      - "Gemfile"
      - "Gemfile.lock"
      - "!.github/workflows/broken-links.yml"
      - "!.github/workflows/deploy-docker-tag.yml"
      - "!.github/workflows/prettier.yml"
      - "!lighthouse_results/**"
      - "!README.md"
  pull_request:
    branches:
      - master
      - main
    paths:
      - "assets/**"
      - "_sass/**"
      - "_scripts/**"
      - "**.bib"
      - "**.html"
      - "**.js"
      - "**.liquid"
      - "**/*.md"
      - "**/*.Rmd"
      - "**/*.R"
      - "**.yml"
      - "Gemfile"
      - "Gemfile.lock"
      - "!.github/workflows/broken-links.yml"
      - "!.github/workflows/deploy-docker-tag.yml"
      - "!.github/workflows/prettier.yml"
      - "!lighthouse_results/**"
      - "!README.md"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
      - name: Set up Docker (Buildx) ğŸ‹
        uses: docker/setup-buildx-action@v2
      - name: Build ğŸ”§
        run: make JEKYLL_VERSION=4.4.1 site
      - name: Verify build ğŸ”
        run: |
          if [ ! -d _site ]; then
            echo "Build failed: _site/ not found"
            exit 1
          fi
      - name: Deploy ğŸš€
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_PAGES_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./_site --project-name=gabrielebaldassarre
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}